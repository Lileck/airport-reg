{% extends 'flights/base.html' %}

{% block title %}–ü–æ–∏—Å–∫ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
    <h1>üîç –ü–æ–∏—Å–∫ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</h1>
    <p>–ù–∞–π–¥–∏—Ç–µ –ø–∞—Å—Å–∞–∂–∏—Ä–∞ –ø–æ –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä—É –ø–∞—Å–ø–æ—Ä—Ç–∞</p>
</div>

<!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
<div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0;">
    <form method="get" style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–ü–æ–∏—Å–∫:</label>
            <input type="text" name="search" value="{{ search_query }}"
                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞...">
        </div>
        <button type="submit" style="background: #3498db; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; height: fit-content;">
            üîç –ù–∞–π—Ç–∏
        </button>
    </form>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
{% if search_query %}
<div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0;">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "{{ search_query }}"</h2>

    {% if passengers_data %}
        {% for data in passengers_data %}
        <div style="border: 1px solid #e0e0e0; padding: 25px; margin: 20px 0; border-radius: 10px; background: #f8f9fa;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 30px;">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Å—Å–∞–∂–∏—Ä–µ -->
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 24px;">
                        {{ data.passenger.first_name }} {{ data.passenger.last_name }}
                    </h3>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                        <h4 style="margin: 0 0 12px 0; color: #2c3e50;">üìã –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>üìá –ü–∞—Å–ø–æ—Ä—Ç:</strong><br>
                                <span style="font-family: monospace; font-size: 16px; color: #2c3e50;">{{ data.passenger.passport_number }}</span>
                            </div>
                            <div>

                                <strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong><br>
                                <span style="color: #27ae60; font-weight: 500;">{{ data.passenger.phone|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ -->
                    {% if data.passenger.flight %}
                    <div style="background: #e8f4fd; padding: 18px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                        <h4 style="margin: 0 0 12px 0; color: #2c3e50;">‚úàÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>–ù–æ–º–µ—Ä —Ä–µ–π—Å–∞:</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #e74c3c;">{{ data.passenger.flight.number }}</span>
                            </div>
                            <div>
                                <strong>–ú–∞—Ä—à—Ä—É—Ç:</strong><br>
                                {{ data.passenger.flight.departure_city }} ‚Üí {{ data.passenger.flight.destination_city }}
                            </div>
                            <div>
                                <strong>–í—ã–ª–µ—Ç:</strong><br>
                                {{ data.passenger.flight.departure_time|date:"d.m.Y H:i" }}
                            </div>
                            <div>
                                <strong>–í—ã—Ö–æ–¥:</strong><br>
                                {{ data.passenger.flight.gate|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                <div style="min-width: 300px;">
                    {% if data.is_registered %}
                        {% for bp in data.boarding_passes %}
                        <div style="background: #e8f6f3; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
                            <h4 style="margin: 0 0 15px 0; color: #27ae60;">‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h4>

                            <div style="margin-bottom: 15px;">
                                <strong>–†–µ–π—Å:</strong><br>
                                <span style="font-size: 18px; font-weight: bold; color: #2c3e50;">{{ bp.flight.number }}</span>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong>–ù–æ–º–µ—Ä –ø–æ—Å–∞–¥–æ—á–Ω–æ–≥–æ —Ç–∞–ª–æ–Ω–∞:</strong><br>
                                <code style="background: #2c3e50; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px; display: inline-block; margin-top: 5px;">
                                    {{ bp.boarding_pass_number|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}
                                </code>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong>–ú–∞—Ä—à—Ä—É—Ç:</strong><br>
                                {{ bp.flight.departure_city }} ‚Üí {{ bp.flight.destination_city }}
                            </div>

                            <div style="margin-bottom: 15px;">
                                <strong>–í—ã—Ö–æ–¥:</strong><br>
                                {{ bp.flight.gate|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
                            </div>

                            <!-- –ü–æ—Å–∞–¥–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ -->
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px dashed #27ae60;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü–û–°–ê–î–û–ß–ù–û–ï –ú–ï–°–¢–û</div>
                                <div style="font-size: 32px; font-weight: bold; color: #e74c3c; letter-spacing: 2px;">
                                    {{ bp.seat_number|default:"-" }}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 15px;">
                                <span style="color: #27ae60; font-weight: bold; font-size: 16px;">‚óè –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="printBoardingPass('{{ data.passenger.first_name }}', '{{ data.passenger.last_name }}', '{{ data.passenger.passport_number }}', '{{ bp.flight.number }}', '{{ bp.seat_number|default:"–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" }}')"
                                        style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                                    üñ®Ô∏è –ü–µ—á–∞—Ç—å —Ç–∞–ª–æ–Ω–∞
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="background: #fff3cd; padding: 25px; border-radius: 8px; text-align: center; border-left: 4px solid #f39c12;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üö´</div>
                            <strong style="color: #856404; font-size: 16px;">–ü–∞—Å—Å–∞–∂–∏—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</strong><br>
                            <small style="color: #856404;">–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–π—Å–∞</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: flex-end;">
                {% if data.passenger.flight %}
                <a href="{% url 'flights:flight_checkin' data.passenger.flight.id %}"
                   style="background: #3498db; color: white; padding: 12px 25px; text-decoration: none; border-radius: 6px; text-align: center; font-weight: bold; display: inline-block;">
                    üìù –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 18px;">üòî –ü–∞—Å—Å–∞–∂–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div style="margin-top: 30px;">
    <a href="{% url 'flights:agent_dashboard' %}" style="background: #6c757d; color: white; padding: 12px 25px; border-radius: 5px; text-decoration: none; font-weight: bold;">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ –∞–≥–µ–Ω—Ç–∞
    </a>
</div>

<script>
function printBoardingPass(firstName, lastName, passport, flightNumber, seat) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–µ—Å—Ç–æ
    if (!seat || seat === 'None' || seat === '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ' || seat === '-') {
        seat = '–ù–ï –ù–ê–ó–ù–ê–ß–ï–ù–û';
    }

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>–ü–æ—Å–∞–¥–æ—á–Ω—ã–π —Ç–∞–ª–æ–Ω</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    .boarding-pass { border: 2px solid #000; padding: 25px; max-width: 400px; margin: 0 auto; }
                    .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                    .passenger-info { margin-bottom: 20px; line-height: 1.6; }
                    .seat { text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                    .barcode { text-align: center; margin-top: 25px; font-family: monospace; font-size: 16px; }
                    .flight-number { font-size: 24px; font-weight: bold; color: #e74c3c; }
                    .seat-number { font-size: 32px; font-weight: bold; color: #2c3e50; }
                </style>
            </head>
            <body>
                <div class="boarding-pass">
                    <div class="header">
                        <h1 style="margin: 0; font-size: 28px;">–ü–û–°–ê–î–û–ß–ù–´–ô –¢–ê–õ–û–ù</h1>
                        <div class="flight-number">${flightNumber}</div>
                    </div>
                    <div class="passenger-info">
                        <strong>–ü–∞—Å—Å–∞–∂–∏—Ä:</strong> ${firstName} ${lastName}<br>
                        <strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong> ${passport}<br>
                    </div>
                    <div class="seat">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">–ú–ï–°–¢–û</div>
                        <div class="seat-number">${seat}</div>
                    </div>
                    <div class="barcode">
                        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà<br>
                        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà<br>
                        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà<br>
                        ${flightNumber} - ${passport}
                    </div>
                    <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
                        ${new Date().toLocaleDateString('ru-RU')}
                    </div>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}